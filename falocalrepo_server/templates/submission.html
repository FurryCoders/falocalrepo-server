<!DOCTYPE html>
<!--suppress HtmlDeprecatedAttribute, HtmlUnknownTarget, CssUnusedSymbol -->
<html lang="en">
<head>
    <title>{{ title }} Â· {{ app }}</title>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport">
    <meta content="ie=edge" http-equiv="x-ua-compatible">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" href="/touch-icon.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
    <link rel="stylesheet" href="/static/styles/bootstrap.min.css">
    <link rel="stylesheet" href="/static/styles/style.css">
    {% set is_image = submission.TYPE.lower() == "image" or (submission.TYPE.lower() == "flash" and submission.FILEEXT.lower() in ["gif", "jpg", "png"]) %}
    {% set is_flash = submission.TYPE.lower() == "flash" and submission.FILEEXT.lower() == "swf" %}
    <style>
        #file-container ~ #metadata .card {
            height: 100%;
        }

        {% if is_image %}
            .fit-height.zoomed {
                max-height: none !important;
            }

            .sticky-top .fit-height.zoomed {
                max-height: 100vh;
            }

            #file-container.sticky-top img.zoom {
                transition: all 250ms;
            }

            body:not([data-scroll="0"]) #file-container.sticky-top img.zoom {
                border-radius: .25rem;
            }

            #file-container.sticky-top ~ #button-sticky {
                color: #fff;
                background-color: #198754;
                border-color: #198754
            }

            #file-container.sticky-top ~ #button-sticky:hover {
                color: #fff;
                background-color: #157347;
                border-color: #146c43
            }

            #file-container.sticky-top ~ #button-sticky:focus {
                color: #fff;
                background-color: #157347;
                border-color: #146c43;
                box-shadow: 0 0 0 .25rem rgba(60, 153, 110, .5)
            }

            #file-container.sticky-top ~ #button-sticky.active {
                color: #fff;
                background-color: #146c43;
                border-color: #13653f
            }

            @media (min-width: 991px) {
                #file-container.zoomed {
                    width: 100%;
                    margin-bottom: 1rem;
                }

                #file-container.zoomed ~ #metadata {
                    order: 2 !important
                }

                #file-container.zoomed ~ #metadata .card {
                    height: auto;
                }

                #file-container.zoomed ~ #description {
                    width: 66.66666667%;
                    margin-top: 0 !important;
                    order: 1 !important
                }

                #file-container.zoomed ~ #description .card {
                    height: 100%;
                }

                #file-container.zoomed ~ #description .card-body {
                    width: 100%;
                }
            }
        {% elif is_flash %}
            #flash-container > ruffle-player {
                max-width: 100% !important;
            }
        {% endif %}
    </style>
</head>
<body class="mt-3 mt-lg-4 mb-4" data-scroll="0">

{% set file %}
{% if submission.FILESAVED < 2 %}
<div class="mt-1 mb-2 mt-lg-5 pt-lg-5 text-center">
    <span class="badge bg-danger">Submission has no file</span>
</div>
{% elif is_image %}
<div class="text-center">
    <div class="mt-1 mb-2 mt-lg-5 pt-lg-5" id="image-error" hidden>
        <span class="badge bg-danger">Image not found</span>
    </div>
    <div class="mt-2 mb-2 mt-lg-5 pt-lg-5" id="image-loading">
        <span class="spinner spinner-border spinner-border-sm" role="status"></span>
    </div>
    <img class="img-fluid mx-auto fit-height zoom" id="submission-image"
         src="/submission/{{ submission.ID }}/file/{{ filename_id }}" alt=""
         onclick="if (!this.classList.contains('zoomed')) {this.classList.add('zoomed'); document.getElementById('file-container').classList.add('zoomed')} else {this.classList.remove('zoomed'); document.getElementById('file-container').classList.remove('zoomed')}"
         onload="this.parentNode.querySelector('#image-loading').hidden = true; document.getElementById('button-sticky').hidden = this.hidden = false"
         onerror="this.parentNode.querySelector('#image-loading').hidden = true; this.parentNode.querySelector('#image-error').hidden = false"
         hidden>
</div>
{% elif is_flash %}
<div class="text-center">
    <div class="mt-1 mb-2 mt-lg-5 pt-lg-5" id="flash-error" hidden>
        <span class="badge bg-danger">Ruffle error</span>
    </div>
    <div class="mt-2 mb-2 mt-lg-5 pt-lg-5" id="flash-loading">
        <span class="spinner spinner-border spinner-border-sm" role="status"></span>
    </div>
    <div class="fit-height mx-auto" id="flash-container" hidden></div>
</div>
{% elif submission.TYPE.lower() == "music" %}
<div class="text-center mb-1 mt-lg-5 pt-lg-5">
    <div class="col-12 text-center" style="min-height: 120px">
        <span class="badge bg-danger" id="thumbnail-error" style="margin-top: calc(60px - .5rem)" hidden>Thumbnail not found</span>
        <span class="spinner spinner-border spinner-border-sm" id="thumbnail-loading" role="status"
              style="margin-top: calc(60px - .5rem)"></span>
        <img class="img-fluid rounded" src="/submission/{{ submission.ID }}/thumbnail" alt=""
             onload="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.hidden = false"
             onerror="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.parentNode.querySelector('#thumbnail-error').hidden = false"
             hidden>
    </div>
    <div class="mt-2">
        <span class="badge bg-danger" id="file-error" hidden>File not found</span>
        <audio src="/submission/{{ submission.ID }}/file/{{ filename_id }}"
               onerror="this.hidden = true; this.parentNode.querySelector('#file-error').hidden = false"
               controls>
        </audio>
    </div>
</div>
{% elif file_text is not none %}
<div class="border rounded p-2 text-start font-monospace small overflow-scroll text-wrap fit-height">
    <div class="col-12 text-center" style="min-height: 120px">
        <span class="badge bg-danger" id="thumbnail-error" style="margin-top: calc(60px - .5rem)" hidden>Thumbnail not found</span>
        <span class="spinner spinner-border spinner-border-sm" id="thumbnail-loading" role="status"
              style="margin-top: calc(60px - .5rem)"></span>
        <img class="img-fluid rounded" src="/submission/{{ submission.ID }}/thumbnail/" alt=""
             onload="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.hidden = false"
             onerror="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.parentNode.querySelector('#thumbnail-error').hidden = false"
             hidden>
    </div>
    <div class="mt-2">
        {% autoescape false %}{{ file_text.strip() }}{% endautoescape %}
    </div>
</div>
{% else %}
<div class="text-center mb-2 mt-lg-5 pt-lg-5">
    <div class="col-12 text-center" style="min-height: 120px">
        <span class="badge bg-danger" id="thumbnail-error" style="margin-top: calc(60px - .5rem)" hidden>Thumbnail not found</span>
        <span class="spinner spinner-border spinner-border-sm" id="thumbnail-loading" role="status"
              style="margin-top: calc(60px - .5rem)"></span>
        <img class="img-fluid rounded" src="/submission/{{ submission.ID }}/thumbnail" alt=""
             onload="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.hidden = false"
             onerror="this.parentNode.querySelector('#thumbnail-loading').hidden = true; this.parentNode.querySelector('#thumbnail-error').hidden = false"
             hidden>
    </div>
    <a class="btn btn-sm btn-primary mt-2" href="/submission/{{ submission.ID }}/file/{{ filename_id }}">
        {{ filename|title }}
    </a>
</div>
{% endif %}
{% endset %}

<div class="container">
    <div class="row align-middle">
        <div class="col-12 col-lg-8" style="z-index: 1 !important" id="file-container">{{ file }}</div>

        <div class="col-12 col-lg-4 mt-3 mt-lg-0 mx-auto" id="metadata">
            <div class="card">
                <h2 class="card-header">{{ submission.TITLE }}</h2>
                <div class="card-header d-lg-none text-center">
                    <div class="btn-group col-12 col-md-8" role="group">
                        <a class="btn btn-sm btn-primary {{ "disabled" if not next }}" href="/submission/{{ next }}">
                            Next
                        </a>
                        <span class="btn-separator"></span>
                        <a class="btn btn-sm btn-primary" href="/gallery/{{ submission.AUTHOR }}">Gallery</a>
                        <span class="btn-separator"></span>
                        <a class="btn btn-sm btn-primary" href="/submissions/{{ submission.AUTHOR }}">All</a>
                        <span class="btn-separator"></span>
                        <a class="btn btn-sm btn-primary" href="/scraps/{{ submission.AUTHOR }}">Scraps</a>
                        <span class="btn-separator"></span>
                        <a class="btn btn-sm btn-primary {{ "disabled" if not prev }}" href="/submission/{{ prev }}">
                            Prev
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <h6 class="col-4 card-title">Author</h6>
                        <div class="col-8 card-text">
                            <a class="col-8 card-text btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/user/{{ submission.AUTHOR }}">{{ submission.AUTHOR }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Date</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge text-truncate text-decoration-none w-100"
                               href="/search/submissions/?query=%40date%20{{ submission.DATE.strftime("%Y-%m-%d") }}">
                                {{ submission.DATE.strftime("%Y-%m-%d %H:%M") }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Folder</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/{{ submission.FOLDER }}/{{ submission.AUTHOR }}">
                                {{ submission.FOLDER|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Type</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/search/submissions/?query=%40type%20%22{{ submission.TYPE }}%22">
                                {{ submission.TYPE|title }}
                                {{ "({})".format(submission.FILEEXT.upper()) if submission.TYPE.lower() == "flash" and submission.FILEEXT.lower() != "swf" }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Category</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/search/submissions/?query=%40category%20%22{{ submission.CATEGORY }}%22">
                                {{ submission.CATEGORY|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Species</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/search/submissions/?query=%40species%20%22{{ submission.SPECIES }}%22">
                                {{ submission.SPECIES|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Gender</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/search/submissions/?query=%40gender%20%22{{ submission.GENDER }}%22">
                                {{ submission.GENDER|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Rating</h6>
                        <div class="col-8 card-text">
                            <a class="btn-sm btn-primary badge w-100 text-truncate text-decoration-none"
                               href="/search/submissions/?query=%40rating%20%22{{ submission.RATING }}%22">
                                {{ submission.RATING|title }}
                            </a>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Tags</h6>
                        <div class="col-8 card-text">
                            {% for tag in submission.TAGS %}
                                <a class="btn-sm btn-primary badge text-truncate text-decoration-none"
                                   href='/search/submissions/?query=%40tags%20%22%7C{{ tag }}%7C%22'>{{ tag }}</a>
                            {% endfor %}
                            {% if not submission.TAGS %}
                                <span class="badge bg-danger w-100 text-truncate">No tags</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Favorites</h6>
                        <div class="col-8 card-text">
                            {% for user in submission.FAVORITE %}
                                <a class="btn-sm btn-primary badge text-truncate text-decoration-none"
                                   href="/user/{{ user }}">{{ user }}</a>
                            {% endfor %}
                            {% if not submission.FAVORITE %}
                                <span class="badge bg-danger w-100 text-truncate">No favorites</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-1">
                        <h6 class="col-4 card-title">Mentions</h6>
                        <div class="col-8 card-text">
                            {% for user in submission.MENTIONS %}
                                <a class="btn-sm btn-primary badge text-truncate text-decoration-none"
                                   href="/user/{{ user }}">{{ user }}</a>
                            {% endfor %}
                            {% if not submission.MENTIONS %}
                                <span class="badge bg-danger w-100 text-truncate">No mentions</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if comments %}
                        <div class="row mt-1">
                            <h6 class="col-4 card-title">Comments</h6>
                            <div class="col-8 card-text">
                                <span class="badge bg-info w-100 text-truncate">{{ comments|length }}</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer text-center">
                    <div class="row text-center">
                        <div class="btn-group col-8 col-md-6 col-lg-8 ms-auto" role="group">
                            <a class="btn btn-sm btn-secondary disabled">Download</a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary {{ "disabled" if submission.FILESAVED < 2 }}"
                               href="/submission/{{ submission.ID }}/file/{{ filename_id }}" download>
                                File
                            </a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary"
                               href="/submission/{{ submission.ID }}/zip/submission-{{ "{0:010}".format(submission.ID) }}.zip">
                                ZIP
                            </a>
                        </div>
                        <div class="btn-group col-4 col-md-2 col-lg-4 me-auto">
                            <a class="btn btn-sm btn-primary"
                               href="https://www.furaffinity.net/view/{{ submission.ID }}">
                                FA
                            </a>
                        </div>
                        <div class="btn-group col-12 mt-1 d-none d-lg-flex" role="group">
                            <a class="btn btn-sm btn-primary {{ "disabled" if not next }}"
                               href="/submission/{{ next }}">
                                Next
                            </a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary" href="/gallery/{{ submission.AUTHOR }}">Gallery</a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary" href="/submissions/{{ submission.AUTHOR }}">All</a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary" href="/scraps/{{ submission.AUTHOR }}">Scraps</a>
                            <span class="btn-separator"></span>
                            <a class="btn btn-sm btn-primary {{ "disabled" if not prev }}"
                               href="/submission/{{ prev }}">
                                Prev
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt-3" id="description">
            <div class="card">
                <div class="card-body col-12 col-lg-9 mx-auto">
                    <div class="card-text text-wrap overflow-hidden">
                        {% autoescape false %}{{ submission.DESCRIPTION }}{% endautoescape %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-8 mt-3 mx-auto order-last" id="comments">
            {% if comments %}{% include "comments.html" %}{% endif %}
        </div>

        {% set floating_buttons = 0 %}

        {% if comments %}
            {% set floating_buttons = floating_buttons + 1 %}
            <a href="#comments">
                <button class="btn btn-secondary btn-circle position-fixed"
                        style="right: .25rem; bottom: .25rem; z-index: 1 !important;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                         viewBox="0 0 18 18">
                        <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"></path>
                        <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"></path>
                    </svg>
                </button>
            </a>
        {% endif %}

        {% if is_image %}
            <button id="button-sticky"
                    class="btn btn-secondary btn-circle position-fixed"
                    style="right: .25rem; bottom: {{ "calc(.25rem" + (" + 45px + .25rem" * floating_buttons) + ")" if floating_buttons else ".25rem" }}; z-index: 1 !important;"
                    onclick="const c = document.getElementById('file-container'); c.classList.contains('sticky-top') ? c.classList.remove('sticky-top') : c.classList.add('sticky-top')"
                    hidden>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="mb-1"
                     viewBox="0 0 16 16">
                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path>
                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"></path>
                </svg>
            </button>
        {% endif %}
    </div>
</div>

{% if is_image %}
    <script>
        const margin = Number(window.getComputedStyle(document.body, null).marginTop.replace(/[^\d]/g, ""))
        window.onscroll = () => document.body.dataset.scroll = window.scrollY > margin ? String(window.scrollY) : "0"
    </script>
{% elif is_flash %}
    <!--suppress JSUnresolvedFunction, JSUnusedLocalSymbols, JSUnresolvedVariable -->
    <script>
        const ruffleError = (e) => {
            if (e !== undefined) console.error(e)
            document.getElementById("flash-loading").hidden = true
            document.getElementById("flash-container").hidden = true
            document.getElementById("flash-error").hidden = false
        }

        const _console_error = console.error;
        console.error = function (...arguments) {
            if (String(arguments[0]).toLowerCase() === "asynchronous error occurred: invalid swf") ruffleError();
            return _console_error.apply(console, arguments);
        };

        window.RufflePlayer = window.RufflePlayer || {};
        window.addEventListener("load", (event) => {
            if (window.RufflePlayer.newest === undefined) return ruffleError(new Error("Ruffle is not loaded"))
            const player = window.RufflePlayer.newest().createPlayer();
            player.config = {
                scale: "showAll",
            }
            document.getElementById("flash-container").appendChild(player);
            player.addEventListener("loadeddata", () => {
                document.getElementById("flash-loading").hidden = true
                document.getElementById("flash-container").hidden = false
            })
            player.load("/submission/{{ submission.ID }}/file")
                .then()
                .catch(ruffleError);
        });
    </script>
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
{% endif %}
</body>
</html>
